import{d as n}from"./chrome.js";async function i(t,e=null){if(e!=="reset"&&t.website.hostname==="*")return;const a=await chrome.tabs.query({url:`*://${t.website.hostname}/*`});a&&await Promise.all(a.map(async s=>{try{if(!s.id)return;await chrome.tabs.sendMessage(s.id,{action:"update",payload:{settings:t,type:e}})}catch{}}))}async function o(t){let e;t?e=await chrome.tabs.get(t):e=(await chrome.tabs.query({currentWindow:!0,active:!0})).pop();const a=structuredClone(n),s=await chrome.storage.local.get(["_global"]);if(s._global&&(a.global=s._global),!e?.id||!e.url)return a;try{await chrome.scripting.executeScript({target:{tabId:e.id},func:()=>!0})}catch{return a}const{hostname:r}=new URL(e.url);a.website.hostname=r;const c=await chrome.storage.local.get([r]);return c[r]&&(a.website=c[r]),a}async function l(t){if((t.website.hostname==="*"||t.website.mode==="global")&&await chrome.storage.local.set({_global:t.global}),t.website.hostname==="*")return;const e=await o();await chrome.storage.local.set({[e.website.hostname]:t.website}),await i(t)}async function b(){return(await chrome.commands.getAll())[1].shortcut}chrome.runtime.onMessage.addListener((t,e,a)=>{switch(t.type){case"getSettings":return o().then(s=>a(s)),!0;case"saveSettings":l(t.payload);break;case"resetSettings":chrome.storage.local.clear().then(()=>i(n,"reset"));break;case"getShortcut":return b().then(s=>a(s)),!0}});chrome.commands.onCommand.addListener(async t=>{const e=await o();switch(t){case"activate":e.website.on=!e.website.on;break;case"global":e.website.mode=e.website.mode==="global"?"website":"global";break}await l(e)});chrome.tabs.onUpdated.addListener(async(t,e)=>{e.status==="complete"&&await i(await o(t))});chrome.tabs.onActivated.addListener(async t=>{t.tabId&&await i(await o(t.tabId),"activated")});
